<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Harvi">
    <meta name="theme-color" content="#0EA5E9">
    <meta name="msapplication-navbutton-color" content="#0EA5E9">
    <meta name="description" content="Harvi - Comprehensive medical multiple-choice questions for exam preparation">
    <meta name="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%230EA5E9' width='192' height='192'/><text x='50%' y='50%' font-size='120' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='central'>H</text></svg>">
    <link rel="apple-touch-startup-image" href="/icons/icon-512x512.png">
    <title>Harvi - Medical MCQ Learning Platform</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/utils/mobile.css">
    <link rel="stylesheet" href="./css/components/glassmorphism.css">
    <link rel="stylesheet" href="./css/components/view-transitions.css">
    <link rel="stylesheet" href="./css/components/showcase-glass-2.0.css">
    <link rel="stylesheet" href="./css/components/bottom-nav.css">
    <link rel="stylesheet" href="./css/components/pwa-features.css">
    <link rel="stylesheet" href="./css/components/apple-material-system.css">
    <link rel="stylesheet" href="./css/components/stats.css">
    <link rel="stylesheet" href="./css/components/profile.css">
    <link rel="stylesheet" href="./css/components/home-hub.css">
    <link rel="stylesheet" href="./css/components/native-navigation.css">
    <link rel="stylesheet" href="./css/components/modals.css">
    <link rel="stylesheet" href="./css/components/dynamic-island.css">
    <!-- Preload fonts with font-display: swap for better performance - DISABLED to reduce external requests -->
    <!--
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" as="style">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    -->
    <script src="./js/adaptive-performance.js"></script>
    <script src="./js/haptics-engine.js"></script>
    <script src="./js/animations.js"></script>
    <script src="./js/showcase-features.js"></script>
    <script src="./js/dynamic-island.js"></script>
    <script src="./js/native-gesture-engine.js"></script>
    <script src="./js/pwa-features.js"></script>
    <script src="./js/motion-coordinator.js"></script>
    <script src="./js/touch-highlight.js"></script>
    <script src="./js/db.js"></script>
</head>

<body class="mobile-touch-fix">
    <!-- Animated Mesh Background -->
    <div class="mesh-background">
        <div class="mesh-gradient"></div>
    </div>

    <div id="app" class="ios-touch-optimized">
        <div id="navigation-screen" class="screen active">
            <div class="container">
                <div class="header-container">
                    <div id="header-content-wrapper">
                        <!-- Brand/Logo Area (Clickable to return home) -->
                        <button class="brand-container" id="brand-container"
                            style="background: none; border: none; cursor: pointer; padding: 0;">
                            <h1 class="app-title">Harvi</h1>
                            <p class="brand-description">Questions you need</p>
                        </button>

                        <!-- Dynamic Navigation Area (Large Title / Inline Title) -->
                        <div id="navigation-title-area" style="display: none;">
                            <!-- Populated by navigation.js -->
                        </div>
                    </div>
                </div>
                <div class="breadcrumb" id="breadcrumb"></div>
                <div class="cards-grid" id="cards-container"></div>
            </div>
        </div>

        <div id="quiz-screen" class="screen">
            <div class="quiz-container">
                <div class="quiz-header">
                    <button class="back-btn" id="back-to-nav" aria-label="Go back">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="quiz-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <span class="question-counter"><span id="current-question">1</span> / <span
                                id="total-questions">10</span></span>
                    </div>
                </div>
                <div class="quiz-content" id="quiz-content-area">
                    <h2 class="question-text" id="question-text">Question text goes here?</h2>
                    <div class="options-container" id="options-container">
                    </div>
                </div>
                <div class="continue-btn-wrapper">
                    <button class="continue-btn" id="continue-btn" disabled>Continue</button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="screen results-screen">
            <div class="results-container" id="results-container">
                <div class="results-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="white">
                        <path
                            d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                    </svg>
                </div>
                <h1 class="results-title">Great Work!</h1>
                <p class="results-message" id="results-message">You've successfully mastered this high-yield topic.
                    Knowledge is power.</p>

                <div class="score-display">
                    <div class="score-number" id="score-number">0</div>
                    <div class="score-percentage" id="score-percentage">0% Mastery</div>
                    <div class="score-text">Score: <span id="current-score-val">0</span> / <span
                            id="total-score">0</span></div>
                </div>

                <div class="results-actions">
                    <button class="action-btn-pwa btn-primary-victory" id="back-to-home">
                        <span>Done for Now</span>
                    </button>
                    <button class="action-btn-pwa btn-secondary-victory" id="retake-quiz">
                        <span>Revisit Topic</span>
                    </button>
                    <button class="share-results-btn" id="share-results">
                        Share Achievement
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Screen -->
        <div id="stats-screen" class="screen">
            <div class="container">
                <div class="header-container">
                    <button class="brand-container" id="brand-stats"
                        style="background: none; border: none; cursor: pointer; padding: 0;">
                        <h1 class="app-title">Statistics</h1>
                        <p class="brand-description">Your progress at a glance</p>
                    </button>
                </div>
                <div id="stats-content">
                    <!-- Stats will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profile-screen" class="screen">
            <div class="container">
                <div class="header-container">
                    <button class="brand-container" id="brand-profile"
                        style="background: none; border: none; cursor: pointer; padding: 0;">
                        <h1 class="app-title">Profile</h1>
                        <p class="brand-description">Personalize your experience</p>
                    </button>
                </div>
                <div id="profile-content">
                    <!-- Profile content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="js/navigation.js"></script>
    <script src="js/quiz.js"></script>
    <script src="js/results.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/app.js"></script>

    <!-- PWA: Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', {
                    scope: './',
                    updateViaCache: 'none'  // â† ADD: Always check for updates
                })
                    .then(registration => {
                        console.log('âœ“ Service Worker registered:', registration);
                        // CRITICAL FIX: Check for updates IMMEDIATELY on load
                        console.log('ðŸ”„ Checking for service worker updates...');
                        registration.update().catch(err => {
                            console.warn('Update check failed:', err);
                        });
                        // NEW: Use Page Visibility API instead of setInterval
                        // This works reliably even when page is backgrounded
                        let visibilityChangeHandler = () => {
                            if (!document.hidden) {
                                console.log('ðŸ“± App became visible - checking for updates');
                                registration.update().catch(err => {
                                    console.warn('Update check failed:', err);
                                });
                            }
                        };

                        document.addEventListener('visibilitychange', visibilityChangeHandler);

                        // REMOVED: Focus handler to reduce update checks
                        // window.addEventListener('focus', focusHandler);

                        // NEW: Periodic check using requestIdleCallback for better performance
                        // Falls back to setTimeout if requestIdleCallback not supported
                        let lastUpdateCheck = Date.now();
                        const UPDATE_CHECK_INTERVAL = 6 * 60 * 60 * 1000; // 6 hours (increased from 1 hour)

                        function scheduleUpdateCheck() {
                            const scheduleCallback = window.requestIdleCallback || window.setTimeout;
                            const timeoutDuration = window.requestIdleCallback ? undefined : UPDATE_CHECK_INTERVAL;

                            scheduleCallback(() => {
                                const now = Date.now();
                                if (now - lastUpdateCheck >= UPDATE_CHECK_INTERVAL) {
                                    console.log('â° Periodic update check');
                                    registration.update().catch(err => {
                                        console.warn('Periodic update check failed:', err);
                                    });
                                    lastUpdateCheck = now;
                                }

                                // Schedule next check
                                scheduleUpdateCheck();
                            }, timeoutDuration);
                        }

                        scheduleUpdateCheck();

                        // Handle service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;

                            if (!newWorker) {
                                console.warn('Update found but no installing worker');
                                return;
                            }

                            console.log('ðŸ“¦ New service worker installing...');

                            newWorker.addEventListener('statechange', () => {
                                console.log('Service worker state:', newWorker.state);

                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New service worker installed, but old one still active
                                        console.log('ðŸ†• New version available!');

                                        // Dispatch custom event for app to handle
                                        document.dispatchEvent(new CustomEvent('sw-update-available', {
                                            detail: {
                                                registration: registration,
                                                newWorker: newWorker
                                            }
                                        }));
                                    } else {
                                        // First install
                                        console.log('âœ“ Service worker installed for first time');
                                    }
                                }

                                if (newWorker.state === 'activated') {
                                    console.log('âœ“ New service worker activated');
                                }
                            });
                        });

                        // NEW: Handle controller change (update activated)
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            console.log('ðŸ”„ New service worker activated - reloading app');
                            // Only reload if we're not in the middle of something important
                            if (!document.querySelector('.quiz-screen.active')) {
                                window.location.reload();
                            } else {
                                console.log('Quiz in progress - deferring reload');
                            }
                        });
                    })
                    .catch(error => {
                        console.log('âœ— Service Worker registration failed:', error);
                    });
            });
        }
    </script>

    <!-- Bottom Navigation (Refined Apple HIG Standard) -->
    <div class="bottom-nav-container active" id="bottom-nav-container">
        <nav class="bottom-nav">
            <a href="#" class="bottom-nav-item active" id="nav-home" data-screen="navigation-screen">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L4 9V20C4 20.5523 4.44772 21 5 21H9V15H15V21H19C19.5523 21 20 20.5523 20 20V9L12 2Z"
                        fill="currentColor" fill-opacity="0.1" stroke="currentColor" stroke-width="1.6"
                        stroke-linejoin="round" />
                </svg>
                <span class="bottom-nav-item-label">Home</span>
            </a>
            <a href="#" class="bottom-nav-item" id="nav-stats" data-screen="stats-screen">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 20V12M12 20V4M20 20V16" stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" />
                    <rect x="3" y="11" width="2" height="10" fill="currentColor" fill-opacity="0.1" />
                    <rect x="11" y="3" width="2" height="18" fill="currentColor" fill-opacity="0.1" />
                    <rect x="19" y="15" width="2" height="6" fill="currentColor" fill-opacity="0.1" />
                </svg>
                <span class="bottom-nav-item-label">Statistics</span>
            </a>
            <a href="#" class="bottom-nav-item" id="nav-profile" data-screen="profile-screen">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z"
                        stroke="currentColor" stroke-width="1.6" />
                    <path d="M6 21V19C6 16.7909 7.79086 15 10 15H14C16.2091 15 18 16.7909 18 19V21"
                        stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                    <circle cx="12" cy="7" r="2" fill="currentColor" fill-opacity="0.1" />
                </svg>
                <span class="bottom-nav-item-label">Profile</span>
            </a>
        </nav>
    </div>

</body>

</html>