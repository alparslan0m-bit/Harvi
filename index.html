<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Harvi">
    <meta name="theme-color" content="#0EA5E9">
    <meta name="msapplication-navbutton-color" content="#0EA5E9">
    <meta name="description" content="Harvi - Comprehensive medical multiple-choice questions for exam preparation">
    <meta name="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%230EA5E9' width='192' height='192'/><text x='50%' y='50%' font-size='120' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='central'>H</text></svg>">
    <link rel="apple-touch-startup-image" href="/icons/icon-512x512.png">
    <title>Harvi - Medical MCQ Learning Platform</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/utils/mobile.css">
    <link rel="stylesheet" href="./css/components/glassmorphism.css">
    <link rel="stylesheet" href="./css/components/view-transitions.css">
    <link rel="stylesheet" href="./css/components/showcase-glass-2.0.css">
    <link rel="stylesheet" href="./css/components/bottom-nav.css">
    <link rel="stylesheet" href="./css/components/pwa-features.css">
    <link rel="stylesheet" href="./css/components/apple-material-system.css">
    <link rel="stylesheet" href="./css/components/stats.css">
    <link rel="stylesheet" href="./css/components/profile.css">
    <link rel="stylesheet" href="./css/components/native-navigation.css">
    <link rel="stylesheet" href="./css/components/dynamic-island.css">
    <!-- Preload fonts with font-display: swap for better performance -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" as="style">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="./js/adaptive-performance.js"></script>
    <script src="./js/haptics-engine.js"></script>
    <script src="./js/animations.js"></script>
    <script src="./js/showcase-features.js"></script>
    <script src="./js/dynamic-island.js"></script>
    <script src="./js/native-gesture-engine.js"></script>
    <script src="./js/pwa-features.js"></script>
    <script src="./js/motion-coordinator.js"></script>
    <script src="./js/touch-highlight.js"></script>
    <script src="./js/db.js"></script>
</head>

<body class="mobile-touch-fix">
    <!-- Animated Mesh Background -->
    <div class="mesh-background">
        <div class="mesh-gradient"></div>
    </div>

    <div id="app" class="ios-touch-optimized">
        <div id="navigation-screen" class="screen active">
            <div class="container">
                <div class="header-container">
                    <div id="header-content-wrapper">
                        <!-- Brand/Logo Area (Clickable to return home) -->
                        <button class="brand-container" id="brand-container" style="background: none; border: none; cursor: pointer; padding: 0;">
                            <h1 class="app-title">Harvi</h1>
                            <p class="brand-description">Questions you need</p>
                        </button>

                        <!-- Dynamic Navigation Area (Large Title / Inline Title) -->
                        <div id="navigation-title-area" style="display: none;">
                            <!-- Populated by navigation.js -->
                        </div>
                    </div>
                </div>
                <div class="breadcrumb" id="breadcrumb"></div>
                <div class="cards-grid" id="cards-container"></div>
            </div>
        </div>

        <div id="quiz-screen" class="screen">
            <div class="quiz-container">
                <div class="quiz-header">
                    <button class="back-btn" id="back-to-nav">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="quiz-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <span class="question-counter"><span id="current-question">1</span> / <span
                                id="total-questions">10</span></span>
                    </div>
                </div>
                <div class="quiz-content">
                    <h2 class="question-text" id="question-text">Question text goes here?</h2>
                    <div class="options-container" id="options-container">
                    </div>
                    <button class="btn-primary continue-btn" id="continue-btn" disabled>Continue</button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="screen results-screen">
            <div class="results-container" id="results-container">
                <div class="results-icon">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="none">
                        <path
                            d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
                            fill="#FFD700" stroke="#FFD700" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </div>
                <h1 class="results-title">Quiz Complete!</h1>
                <div class="score-display">
                    <div class="score-info">
                        <div class="score-number" id="score-number">0</div>
                        <div class="score-text">
                            <span class="score-label">Score</span>
                            out of <span id="total-score">2</span> questions
                        </div>
                    </div>
                    <div class="score-percentage" id="score-percentage">0%</div>
                </div>
                <div class="results-message" id="results-message">Keep studying! You can do better next time!</div>
                <div class="results-actions">
                    <button class="share-results-btn" id="share-results" title="Share your score">ðŸ“¤ Share
                        Results</button>
                    <button class="retake-quiz-btn" id="retake-quiz">Retake Quiz</button>
                    <button class="back-home-btn" id="back-to-home">Back to Home</button>
                </div>
            </div>
        </div>

        <!-- Stats Screen -->
        <div id="stats-screen" class="screen">
            <div class="container">
                <div class="header-container">
                    <button class="brand-container" id="brand-stats" style="background: none; border: none; cursor: pointer; padding: 0;">
                        <h1 class="app-title">Statistics</h1>
                    </button>
                </div>
                <div id="stats-content">
                    <!-- Stats will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profile-screen" class="screen">
            <div class="container">
                <div class="header-container">
                    <button class="brand-container" id="brand-profile" style="background: none; border: none; cursor: pointer; padding: 0;">
                        <h1 class="app-title">Profile</h1>
                    </button>
                </div>
                <div id="profile-content">
                    <!-- Profile content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="js/navigation.js"></script>
    <script src="js/quiz.js"></script>
    <script src="js/results.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/app.js"></script>

    <!-- PWA: Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { 
                    scope: './',
                    updateViaCache: 'none'  // â† ADD: Always check for updates
                })
                .then(registration => {
                    console.log('âœ“ Service Worker registered:', registration);
                    // CRITICAL FIX: Check for updates IMMEDIATELY on load
                    console.log('ðŸ”„ Checking for service worker updates...');
                    registration.update().catch(err => {
                        console.warn('Update check failed:', err);
                    });
                    // NEW: Use Page Visibility API instead of setInterval
                    // This works reliably even when page is backgrounded
                    let visibilityChangeHandler = () => {
                        if (!document.hidden) {
                            console.log('ðŸ“± App became visible - checking for updates');
                            registration.update().catch(err => {
                                console.warn('Update check failed:', err);
                            });
                        }
                    };
                    
                    document.addEventListener('visibilitychange', visibilityChangeHandler);
                    
                    // NEW: Also check when window gains focus
                    let focusHandler = () => {
                        console.log('ðŸ” App focused - checking for updates');
                        registration.update().catch(err => {
                            console.warn('Update check failed:', err);
                        });
                    };
                    
                    window.addEventListener('focus', focusHandler);
                    
                    // NEW: Periodic check using requestIdleCallback for better performance
                    // Falls back to setTimeout if requestIdleCallback not supported
                    let lastUpdateCheck = Date.now();
                    const UPDATE_CHECK_INTERVAL = 1 * 60 * 60 * 1000; // 1 hour (reduced from 6)
                    
                    function scheduleUpdateCheck() {
                        const scheduleCallback = window.requestIdleCallback || window.setTimeout;
                        const timeoutDuration = window.requestIdleCallback ? undefined : UPDATE_CHECK_INTERVAL;
                        
                        scheduleCallback(() => {
                            const now = Date.now();
                            if (now - lastUpdateCheck >= UPDATE_CHECK_INTERVAL) {
                                console.log('â° Periodic update check');
                                registration.update().catch(err => {
                                    console.warn('Periodic update check failed:', err);
                                });
                                lastUpdateCheck = now;
                            }
                            
                            // Schedule next check
                            scheduleUpdateCheck();
                        }, timeoutDuration);
                    }
                    
                    scheduleUpdateCheck();

                    // Handle service worker updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        
                        if (!newWorker) {
                            console.warn('Update found but no installing worker');
                            return;
                        }
                        
                        console.log('ðŸ“¦ New service worker installing...');
                        
                        newWorker.addEventListener('statechange', () => {
                            console.log('Service worker state:', newWorker.state);
                            
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // New service worker installed, but old one still active
                                    console.log('ðŸ†• New version available!');
                                    
                                    // Dispatch custom event for app to handle
                                    document.dispatchEvent(new CustomEvent('sw-update-available', {
                                        detail: {
                                            registration: registration,
                                            newWorker: newWorker
                                        }
                                    }));
                                } else {
                                    // First install
                                    console.log('âœ“ Service worker installed for first time');
                                }
                            }
                            
                            if (newWorker.state === 'activated') {
                                console.log('âœ“ New service worker activated');
                            }
                        });
                    });
                    
                    // NEW: Handle controller change (update activated)
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('ðŸ”„ New service worker activated - reloading app');
                        // Only reload if we're not in the middle of something important
                        if (!document.querySelector('.quiz-screen.active')) {
                            window.location.reload();
                        } else {
                            console.log('Quiz in progress - deferring reload');
                        }
                    });
                    })
                    .catch(error => {
                        console.log('âœ— Service Worker registration failed:', error);
                    });
            });
        }
    </script>

    <!-- Bottom Navigation -->
    <div class="bottom-nav-container active" id="bottom-nav-container">
        <nav class="bottom-nav">
            <a href="#" class="bottom-nav-item active" id="nav-home" data-screen="navigation-screen">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h6v-5h2v5h6a1 1 0 001-1v-10"/>
                </svg>
                <span class="bottom-nav-item-label">Home</span>
            </a>
            <a href="#" class="bottom-nav-item" id="nav-stats" data-screen="stats-screen">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 3v18h18M7 16v-8m4 8V8m4 8v-4m4 4V6"/>
                </svg>
                <span class="bottom-nav-item-label">Stats</span>
            </a>
            <a href="#" class="bottom-nav-item" id="nav-profile" data-screen="profile-screen">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>
                </svg>
                <span class="bottom-nav-item-label">Profile</span>
            </a>
        </nav>
    </div>

</body>

</html>